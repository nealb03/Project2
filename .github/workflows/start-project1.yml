name: Start EC2 + Start Backend (MyWebApi)

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region where the instance exists"
        required: true
        default: "us-east-1"
      port:
        description: "Backend port"
        required: true
        default: "5001"

permissions:
  id-token: write
  contents: read

jobs:
  start:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: arn:aws:iam::YOUR_ACCOUNT_ID:role/YOUR_GITHUB_ACTIONS_ROLE

      - name: Start EC2 instance
        shell: bash
        run: |
          set -euo pipefail
          aws ec2 start-instances --instance-ids "i-0aa128f11e1299832" --output table
          aws ec2 wait instance-running --instance-ids "i-0aa128f11e1299832"

      - name: Start Backend on EC2 via SSM (PowerShell)
        shell: bash
        run: |
          set -euo pipefail

          INSTANCE_ID="i-0aa128f11e1299832"
          PORT="${{ inputs.port }}"

          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunPowerShellScript" \
            --comment "Start MyWebApi backend on port $PORT" \
            --parameters commands='[
              "$ErrorActionPreference = ''Stop''",
              "$apiDir = ''C:\Apps\App1-S3-EC2-RDS\Backend\MyWebApi''",
              "if (!(Test-Path $apiDir)) { throw ''API_DIR not found on instance: '' + $apiDir }",
              "$csproj = Join-Path $apiDir ''MyWebApi.csproj''",
              "if (!(Test-Path $csproj)) { throw ''CSPROJ not found on instance: '' + $csproj }",
              "$logDir = ''C:\Apps\logs''",
              "New-Item -ItemType Directory -Force -Path $logDir | Out-Null",
              "$pidFile = Join-Path $logDir ''api.pid''",
              "if (Test-Path $pidFile) { try { $oldPid = Get-Content $pidFile; if ($oldPid) { Stop-Process -Id $oldPid -Force -ErrorAction SilentlyContinue } Remove-Item $pidFile -Force -ErrorAction SilentlyContinue } catch {} }",
              "$ts = Get-Date -Format ''yyyyMMdd-HHmmss''",
              "$outLog = Join-Path $logDir (''api-out-'' + $ts + ''.txt'')",
              "$errLog = Join-Path $logDir (''api-err-'' + $ts + ''.txt'')",
              "$psi = New-Object System.Diagnostics.ProcessStartInfo",
              "$psi.FileName = ''dotnet''",
              "$psi.Arguments = ''run --project ""'' + $csproj + ''"" --urls http://0.0.0.0:'"$PORT"'''",
              "$psi.WorkingDirectory = $apiDir",
              "$psi.UseShellExecute = $false",
              "$psi.RedirectStandardOutput = $true",
              "$psi.RedirectStandardError  = $true",
              "$psi.CreateNoWindow = $true",
              "$p = New-Object System.Diagnostics.Process",
              "$p.StartInfo = $psi",
              "$null = $p.Start()",
              "$p.Id | Out-File -FilePath $pidFile -Force",
              "''Started pid='' + $p.Id | Out-File -FilePath $outLog -Append",
              "Start-Sleep -Seconds 2",
              "if ($p.HasExited) { ''Process exited early'' | Out-File -FilePath $outLog -Append; exit 1 }",
              "''Backend started OK on port '' + '"$PORT"' | Out-File -FilePath $outLog -Append"
            ]' \
            --output table