      - name: Start Backend on EC2 via SSM (PowerShell) - quoting safe
        shell: bash
        run: |
          set -euo pipefail

          INSTANCE_ID="i-0aa128f11e1299832"
          PORT="${{ inputs.port }}"

          # Build the PowerShell script to run ON the EC2 instance
          cat > start-backend.ps1 <<'PS1'
          $ErrorActionPreference = "Stop"

          $apiDir = "C:\Apps\App1-S3-EC2-RDS\Backend\MyWebApi"
          if (!(Test-Path $apiDir)) { throw "API_DIR not found on instance: $apiDir" }

          $csproj = Join-Path $apiDir "MyWebApi.csproj"
          if (!(Test-Path $csproj)) { throw "CSPROJ not found on instance: $csproj" }

          $logDir = "C:\Apps\logs"
          New-Item -ItemType Directory -Force -Path $logDir | Out-Null

          $pidFile = Join-Path $logDir "api.pid"
          if (Test-Path $pidFile) {
            try {
              $oldPid = (Get-Content $pidFile -ErrorAction SilentlyContinue)
              if ($oldPid) { Stop-Process -Id $oldPid -Force -ErrorAction SilentlyContinue }
              Remove-Item $pidFile -Force -ErrorAction SilentlyContinue
            } catch {}
          }

          $ts = Get-Date -Format "yyyyMMdd-HHmmss"
          $outLog = Join-Path $logDir ("api-out-" + $ts + ".txt")
          $errLog = Join-Path $logDir ("api-err-" + $ts + ".txt")

          $port = "__PORT__"

          $psi = New-Object System.Diagnostics.ProcessStartInfo
          $psi.FileName = "dotnet"
          $psi.Arguments = "run --project `"$csproj`" --urls http://0.0.0.0:$port"
          $psi.WorkingDirectory = $apiDir
          $psi.UseShellExecute = $false
          $psi.RedirectStandardOutput = $true
          $psi.RedirectStandardError  = $true
          $psi.CreateNoWindow = $true

          $p = New-Object System.Diagnostics.Process
          $p.StartInfo = $psi
          $null = $p.Start()

          $p.Id | Out-File -FilePath $pidFile -Force
          ("Started pid=" + $p.Id) | Out-File -FilePath $outLog -Append

          Start-Sleep -Seconds 2
          if ($p.HasExited) {
            "Process exited early" | Out-File -FilePath $outLog -Append
            exit 1
          }

          ("Backend started OK on port " + $port) | Out-File -FilePath $outLog -Append
          PS1

          # Inject port value safely
          sed -i "s/__PORT__/${PORT}/g" start-backend.ps1

          # Base64 encode to avoid JSON quoting problems
          B64=$(base64 -w 0 start-backend.ps1)

          # On the EC2 instance: decode and execute
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunPowerShellScript" \
            --comment "Start MyWebApi backend" \
            --parameters "{\"commands\":[\"[Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('$B64')) | Set-Content -Path C:\\\\Windows\\\\Temp\\\\start-backend.ps1 -Encoding UTF8\",\"powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\\\\Windows\\\\Temp\\\\start-backend.ps1\"]}" \
            --output table