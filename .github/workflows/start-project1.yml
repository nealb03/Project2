- name: Start backend via SSM (rotate logs, kill prior PID, start, verify)
  id: ssm_start
  shell: bash
  run: |
    set -euo pipefail

    PARAMS_JSON=$(jq -n \
      --arg apiDir "$API_DIR" \
      --arg port "$PORT" \
      --arg logDir "C:\\Apps\\logs" \
      --arg pidFile "C:\\Apps\\logs\\api.pid" \
      --arg currentLogs "C:\\Apps\\logs\\api-current-logs.txt" \
      '{
        commands: [
          "$ErrorActionPreference = \"Stop\"",
          ("$apiDir = \"" + $apiDir + "\""),
          ("$port   = \"" + $port + "\""),
          ("$logDir = \"" + $logDir + "\""),
          ("$pidFile = \"" + $pidFile + "\""),
          ("$currentLogs = \"" + $currentLogs + "\""),

          "New-Item -ItemType Directory -Force -Path $logDir | Out-Null",

          "# Stop existing PID first (if any)",
          "if (Test-Path $pidFile) {",
          "  try {",
          "    $oldPid = (Get-Content $pidFile -ErrorAction Stop)",
          "    if ($oldPid -and (Get-Process -Id $oldPid -ErrorAction SilentlyContinue)) {",
          "      Stop-Process -Id $oldPid -Force -ErrorAction SilentlyContinue",
          "      Start-Sleep -Seconds 2",
          "    }",
          "  } catch {}",
          "}",

          "if (!(Test-Path $apiDir)) { throw \"API_DIR not found: $apiDir\" }",

          "# Find dotnet",
          "$dotnetCmd = (Get-Command dotnet -ErrorAction SilentlyContinue)",
          "if ($dotnetCmd) { $dotnet = $dotnetCmd.Source } else {",
          "  $candidates = @(",
          "    \"C:\\\\Program Files\\\\dotnet\\\\dotnet.exe\",",
          "    \"C:\\\\Program Files (x86)\\\\dotnet\\\\dotnet.exe\"",
          "  )",
          "  $dotnet = $null",
          "  foreach ($c in $candidates) { if (Test-Path $c) { $dotnet = $c; break } }",
          "  if (-not $dotnet) { throw \"dotnet not found\" }",
          "}",

          "# Rotate logs (unique per run) to avoid locked file errors",
          "$ts = Get-Date -Format \"yyyyMMdd-HHmmss\"",
          "$outLog = Join-Path $logDir (\"api-out-\" + $ts + \".txt\")",
          "$errLog = Join-Path $logDir (\"api-err-\" + $ts + \".txt\")",

          "\"OUT_LOG=$outLog\" | Out-File -FilePath $currentLogs -Force",
          "\"ERR_LOG=$errLog\" | Out-File -FilePath $currentLogs -Append",

          "\"----- START $ts -----\" | Out-File -FilePath $outLog -Append",
          "\"dotnet=$dotnet\" | Out-File -FilePath $outLog -Append",
          "\"API_DIR=$apiDir PORT=$port\" | Out-File -FilePath $outLog -Append",

          "$cmd = \"cd /d `\"$apiDir`\" && `\"$dotnet`\" run --urls http://0.0.0.0:$port 1>> `\"$outLog`\" 2>> `\"$errLog`\"\"",
          "\"CMD: $cmd\" | Out-File -FilePath $outLog -Append",

          "$p = Start-Process -FilePath \"cmd.exe\" -ArgumentList \"/c\", $cmd -WindowStyle Hidden -PassThru",
          "$p.Id | Out-File -FilePath $pidFile -Force",
          "\"Started pid=$($p.Id)\" | Out-File -FilePath $outLog -Append",

          "Start-Sleep -Seconds 3",
          "if (-not (Get-Process -Id $p.Id -ErrorAction SilentlyContinue)) {",
          "  \"Process exited immediately; dumping err tail\" | Out-File -FilePath $outLog -Append",
          "  if (Test-Path $errLog) { Get-Content $errLog -Tail 120 | Out-File -FilePath $outLog -Append }",
          "  throw \"Backend process did not stay running\"",
          "}"
        ]
      }')

    CMD_ID=$(aws ssm send-command \
      --instance-ids "${INSTANCE_ID}" \
      --document-name "AWS-RunPowerShellScript" \
      --comment "Start Project1 backend via dotnet run (SSM) + verify" \
      --parameters "$PARAMS_JSON" \
      --query "Command.CommandId" --output text)

    echo "command_id=$CMD_ID" >> "$GITHUB_OUTPUT"

    aws ssm wait command-executed --command-id "$CMD_ID" --instance-id "${INSTANCE_ID}" || true
    aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "${INSTANCE_ID}" --output json

    STATUS=$(aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "${INSTANCE_ID}" --query "Status" --output text)
    echo "SSM Status: $STATUS"
    test "$STATUS" = "Success"
