name: Start Project1 Backend (MyWebApi)

on:
  workflow_dispatch:
    inputs:
      port:
        description: "Port for the API"
        required: false
        default: "5001"
      csproj:
        description: "CSProj path relative to repo root"
        required: false
        default: "App1-S3-EC2-RDS/Backend/MyWebApi/MyWebApi.csproj"

jobs:
  start:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print workspace + find csproj (debug)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "GITHUB_WORKSPACE = $env:GITHUB_WORKSPACE"
          Write-Host "Top-level:"
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Force | Format-Table -AutoSize | Out-String | Write-Host
          Write-Host "All *.csproj:"
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.csproj -File |
            ForEach-Object { $_.FullName } | Write-Host

      - name: Start API
        shell: pwsh
        env:
          PORT: ${{ inputs.port }}
          CSPROJ: ${{ inputs.csproj }}
        run: |
          $ErrorActionPreference = "Stop"

          $port = if ([string]::IsNullOrWhiteSpace($env:PORT)) { "5001" } else { $env:PORT }
          $csprojRel = $env:CSPROJ -replace "/", "\"
          $csproj = Join-Path $env:GITHUB_WORKSPACE $csprojRel

          Write-Host "Using csproj: $csproj"
          if (!(Test-Path $csproj)) { throw "CSProj not found: $csproj" }

          dotnet --info
          dotnet restore "$csproj"
          dotnet run --project "$csproj" --urls "http://0.0.0.0:$port"