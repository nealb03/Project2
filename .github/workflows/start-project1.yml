      - name: Start Backend on EC2 via SSM (wait + capture output)
        shell: bash
        run: |
          set -euo pipefail

          INSTANCE_ID="i-0aa128f11e1299832"
          PORT="${{ inputs.port }}"

          cat > _ssm_payload.ps1 <<'PS1'
          $ErrorActionPreference = "Stop"

          $apiDir = "C:\Apps\App1-S3-EC2-RDS\Backend\MyWebApi"
          if (!(Test-Path $apiDir)) { throw "API_DIR not found on instance: $apiDir" }

          $csproj = Join-Path $apiDir "MyWebApi.csproj"
          if (!(Test-Path $csproj)) { throw "CSPROJ not found on instance: $csproj" }

          $logDir = "C:\Apps\logs"
          New-Item -ItemType Directory -Force -Path $logDir | Out-Null

          $pidFile = Join-Path $logDir "api.pid"
          if (Test-Path $pidFile) {
            try {
              $oldPid = (Get-Content $pidFile -ErrorAction SilentlyContinue)
              if ($oldPid) { Stop-Process -Id $oldPid -Force -ErrorAction SilentlyContinue }
              Remove-Item $pidFile -Force -ErrorAction SilentlyContinue
            } catch {}
          }

          $ts = Get-Date -Format "yyyyMMdd-HHmmss"
          $outLog = Join-Path $logDir ("api-out-" + $ts + ".txt")
          $errLog = Join-Path $logDir ("api-err-" + $ts + ".txt")

          $port = "__PORT__"

          $dotnet = (Get-Command dotnet -ErrorAction SilentlyContinue).Source
          if (!$dotnet) { throw "dotnet not found in PATH for this SSM session user" }

          $argList = @(
            "run",
            "--project", "`"$csproj`"",
            "--urls", "http://0.0.0.0:$port"
          ) -join " "

          $p = Start-Process -FilePath $dotnet `
            -ArgumentList $argList `
            -WorkingDirectory $apiDir `
            -WindowStyle Hidden `
            -RedirectStandardOutput $outLog `
            -RedirectStandardError $errLog `
            -PassThru

          $p.Id | Out-File -FilePath $pidFile -Force

          Start-Sleep -Seconds 2
          try { $null = Get-Process -Id $p.Id -ErrorAction Stop } catch { throw "Backend exited immediately. Check $errLog and $outLog" }

          "Started backend PID=$($p.Id) on port $port" | Out-File -FilePath $outLog -Append

          # Show listener status (helps prove it's listening)
          netstat -ano | findstr ":$port" | Out-File -FilePath $outLog -Append
          PS1

          sed -i "s/__PORT__/${PORT}/g" _ssm_payload.ps1
          B64="$(base64 -w 0 _ssm_payload.ps1)"

          COMMAND_ID="$(
            aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunPowerShellScript" \
              --comment "Start Project1 backend (detached) + verify" \
              --parameters "{\"commands\":[\"[Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('$B64')) | Set-Content -Path C:\\\\Windows\\\\Temp\\\\start-backend.ps1 -Encoding UTF8\",\"powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\\\\Windows\\\\Temp\\\\start-backend.ps1\"]}" \
              --query "Command.CommandId" \
              --output text
          )"

          echo "SSM CommandId: $COMMAND_ID"

          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID"

          echo "---- SSM invocation status ----"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "{Status:Status,StatusDetails:StatusDetails,ResponseCode:ResponseCode}" \
            --output table

          echo "---- SSM STDOUT ----"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardOutputContent" \
            --output text || true

          echo "---- SSM STDERR ----"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardErrorContent" \
            --output text || true