name: START - Project1 Backend (NO SSM)

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  PORT: "5001"
  HEALTH_PATH: "/api/health"

jobs:
  start:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start EC2 instance (NO SSM)
        shell: bash
        run: |
          set -euo pipefail
          IID="${{ secrets.PROJECT1_EC2_INSTANCE_ID }}"

          state=$(aws ec2 describe-instances \
            --instance-ids "$IID" \
            --query "Reservations[0].Instances[0].State.Name" \
            --output text)

          echo "Instance state: $state"

          if [ "$state" = "running" ]; then
            echo "Instance already running."
          else
            echo "Starting instance..."
            aws ec2 start-instances --instance-ids "$IID" >/dev/null
            aws ec2 wait instance-running --instance-ids "$IID"
            echo "Instance is running."
          fi

      - name: Wait for backend health endpoint (optional)
        shell: bash
        env:
          PUBLIC_HOST: ${{ secrets.PROJECT1_API_PUBLIC_HOST }}
        run: |
          set -euo pipefail

          if [ -z "${PUBLIC_HOST:-}" ]; then
            echo "PROJECT1_API_PUBLIC_HOST not set; skipping health check."
            exit 0
          fi

          URL="http://${PUBLIC_HOST}:${{ env.PORT }}${{ env.HEALTH_PATH }}"
          echo "Waiting for: $URL"

          for i in {1..60}; do
            if curl -fsS "$URL" >/dev/null; then
              echo "Backend is healthy."
              exit 0
            fi
            echo "Not healthy yet. Sleeping 10s..."
            sleep 10
          done

          echo "Backend did not become healthy in time."
          exit 1