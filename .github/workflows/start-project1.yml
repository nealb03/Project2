name: Start Project1 Backend

on:
  workflow_dispatch:

jobs:
  start:
    runs-on: windows-latest

    steps:
      - name: Start backend API (PowerShell, no JSON parameters)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $apiDir = "C:\Backend01\MyWebApi"
          $port = "5001"
          $logDir = "C:\Apps\logs"
          $pidFile = Join-Path $logDir "api.pid"
          $currentLogs = Join-Path $logDir "api-current-logs.txt"

          New-Item -ItemType Directory -Force -Path $logDir | Out-Null

          if (Test-Path $pidFile) {
            try {
              $oldPid = (Get-Content $pidFile -ErrorAction Stop)
              if ($oldPid -and (Get-Process -Id $oldPid -ErrorAction SilentlyContinue)) {
                Stop-Process -Id $oldPid -Force -ErrorAction SilentlyContinue
                Start-Sleep -Seconds 2
              }
            } catch {}
          }

          if (!(Test-Path $apiDir)) { throw "API_DIR not found: $apiDir" }

          $dotnetCmd = (Get-Command dotnet -ErrorAction SilentlyContinue)
          if ($dotnetCmd) {
            $dotnet = $dotnetCmd.Source
          } else {
            $candidates = @(
              "C:\Program Files\dotnet\dotnet.exe",
              "C:\Program Files (x86)\dotnet\dotnet.exe"
            )
            $dotnet = $null
            foreach ($c in $candidates) { if (Test-Path $c) { $dotnet = $c; break } }
            if (-not $dotnet) { throw "dotnet not found (not in PATH and not in default install locations)" }
          }

          $ts = Get-Date -Format "yyyyMMdd-HHmmss"
          $outLog = Join-Path $logDir ("api-out-" + $ts + ".txt")
          $errLog = Join-Path $logDir ("api-err-" + $ts + ".txt")

          "OUT_LOG=$outLog" | Out-File -FilePath $currentLogs -Force
          "ERR_LOG=$errLog" | Out-File -FilePath $currentLogs -Append

          "----- START $ts -----" | Out-File -FilePath $outLog -Append
          "dotnet=$dotnet" | Out-File -FilePath $outLog -Append
          "API_DIR=$apiDir PORT=$port" | Out-File -FilePath $outLog -Append

          # Start dotnet via cmd.exe to keep it detached from the runner step and redirect logs
          $cmd = "cd /d `"$apiDir`" && `"$dotnet`" run --urls http://0.0.0.0:$port 1>> `"$outLog`" 2>> `"$errLog`""
          "CMD: $cmd" | Out-File -FilePath $outLog -Append

          $p = Start-Process -FilePath "cmd.exe" -ArgumentList "/c", $cmd -WindowStyle Hidden -PassThru
          $p.Id | Out-File -FilePath $pidFile -Force
          "Started pid=$($p.Id)" | Out-File -FilePath $outLog -Append

          Start-Sleep -Seconds 3
          if (-not (Get-Process -Id $p.Id -ErrorAction SilentlyContinue)) {
            "Process exited immediately; dumping err tail" | Out-File -FilePath $outLog -Append
            if (Test-Path $errLog) { Get-Content $errLog -Tail 150 | Out-File -FilePath $outLog -Append }
            throw "Backend process did not stay running"
          }

          try {
            "Listening check:" | Out-File -FilePath $outLog -Append
            (netstat -ano | Select-String (":" + $port + " ")) |
              ForEach-Object { $_.ToString() } |
              Out-File -FilePath $outLog -Append
          } catch {}