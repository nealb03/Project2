name: Start Project1 Backend (MyWebApi)

on:
  workflow_dispatch:
    inputs:
      port:
        description: "Port for the API (dotnet --urls)"
        required: false
        default: "5001"
      project_path:
        description: "Path to the .csproj relative to repository root"
        required: false
        default: "App1-S3-EC2-RDS/Backend/MyWebApi/MyWebApi.csproj"

jobs:
  start:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify project exists
        shell: pwsh
        env:
          PROJECT_PATH: ${{ inputs.project_path }}
        run: |
          $ErrorActionPreference = "Stop"

          $project = Join-Path $env:GITHUB_WORKSPACE ($env:PROJECT_PATH -replace "/", "\")
          Write-Host "GITHUB_WORKSPACE: $env:GITHUB_WORKSPACE"
          Write-Host "Project path:     $project"

          if (!(Test-Path $project)) {
            Write-Host "ERROR: Project not found."
            Write-Host ""
            Write-Host "Available *.csproj files in repo:"
            Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.csproj -File |
              ForEach-Object { $_.FullName } |
              Write-Host
            throw "Project not found: $project"
          }

      - name: Start API (dotnet run)
        shell: pwsh
        env:
          PROJECT_PATH: ${{ inputs.project_path }}
          PORT: ${{ inputs.port }}
        run: |
          $ErrorActionPreference = "Stop"

          $port = if ($env:PORT) { $env:PORT } else { "5001" }
          $project = Join-Path $env:GITHUB_WORKSPACE ($env:PROJECT_PATH -replace "/", "\")
          $projectDir = Split-Path -Parent $project

          Write-Host "Starting API from: $project"
          Write-Host "Working directory: $projectDir"
          Write-Host "Listening on:      http://0.0.0.0:$port"

          dotnet --info
          dotnet restore "$project"
          dotnet run --project "$project" --urls "http://0.0.0.0:$port"