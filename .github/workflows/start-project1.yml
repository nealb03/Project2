name: Start Project1 (EC2 + Backend)

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS Region"
        required: true
        default: "us-east-1"
      instance_id:
        description: "EC2 instance id"
        required: true
        default: "i-0aa128f11e1299832"
      port:
        description: "Backend port"
        required: true
        default: "5001"

permissions:
  id-token: write
  contents: read

jobs:
  start:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: arn:aws:iam::288761763536:role/GithubActionsRole

      - name: Start EC2 and wait until running
        shell: bash
        run: |
          set -euo pipefail
          aws ec2 start-instances --instance-ids "${{ inputs.instance_id }}" --output table
          aws ec2 wait instance-running --instance-ids "${{ inputs.instance_id }}"

      - name: Wait for SSM agent Online
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ inputs.instance_id }}"

          echo "Waiting for SSM Online for $INSTANCE_ID ..."
          for i in $(seq 1 90); do
            STATUS="$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=$INSTANCE_ID" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text 2>/dev/null || true)"
            echo "SSM PingStatus: ${STATUS:-<none>}"
            if [ "$STATUS" = "Online" ]; then
              echo "SSM is Online."
              exit 0
            fi
            sleep 10
          done

          echo "SSM did not become Online. Fix instance IAM profile (AmazonSSMManagedInstanceCore), SSM agent, or networking."
          exit 1

      - name: Start Backend via SSM (non-blocking) + poll invocation output
        shell: bash
        run: |
          set -euo pipefail
          INSTANCE_ID="${{ inputs.instance_id }}"
          PORT="${{ inputs.port }}"

          # PowerShell is passed as separate "commands" lines to AWS-RunPowerShellScript.
          # This avoids long base64 payloads and prevents hangs.
          read -r -d '' CMD1 <<'PS'
          $ErrorActionPreference="Stop"
          $port=__PORT__
          $apiDir="C:\Backend01\MyWebApi"
          if(!(Test-Path $apiDir)){ throw "API_DIR not found: $apiDir" }
          $csproj=Join-Path $apiDir "MyWebApi.csproj"
          if(!(Test-Path $csproj)){ throw "CSPROJ not found: $csproj" }
          $logDir="C:\Apps\logs"; New-Item -ItemType Directory -Force -Path $logDir | Out-Null
          $pidFile=Join-Path $logDir "api.pid"

          if(Test-Path $pidFile){
            try { $oldPid=Get-Content $pidFile -EA SilentlyContinue; if($oldPid){ Stop-Process -Id $oldPid -Force -EA SilentlyContinue } } catch {}
            try { Remove-Item $pidFile -Force -EA SilentlyContinue } catch {}
          }

          $ts=Get-Date -Format "yyyyMMdd-HHmmss"
          $outLog=Join-Path $logDir ("api-out-"+$ts+".txt")
          $errLog=Join-Path $logDir ("api-err-"+$ts+".txt")

          $dotnet=(Get-Command dotnet -EA SilentlyContinue).Source
          if(!$dotnet){
            $fallback="C:\Program Files\dotnet\dotnet.exe"
            if(Test-Path $fallback){ $dotnet=$fallback } else { throw "dotnet not found" }
          }

          $argList="run --project `"$csproj`" --urls http://0.0.0.0:$port"
          $p=Start-Process -FilePath $dotnet -ArgumentList $argList -WorkingDirectory $apiDir -WindowStyle Hidden -RedirectStandardOutput $outLog -RedirectStandardError $errLog -PassThru
          $p.Id | Out-File -FilePath $pidFile -Force

          Start-Sleep -Seconds 3
          netstat -ano | findstr (":" + $port) | Out-String | Out-File -FilePath $outLog -Append
          "Started PID=$($p.Id) Port=$port Out=$outLog Err=$errLog" | Out-File -FilePath $outLog -Append
          PS

          CMD1="${CMD1/__PORT__/$PORT}"

          COMMAND_ID="$(
            aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunPowerShellScript" \
              --comment "Start backend detached + write logs" \
              --parameters "{\"commands\":[$(python3 - <<PY
import json
cmds = ["powershell -NoProfile -Command " + json.dumps(CMD1)]
print(",".join([json.dumps(c) for c in cmds]))
PY
)]}" \
              --query "Command.CommandId" \
              --output text
          )"

          echo "SSM CommandId: $COMMAND_ID"

          # Poll until terminal state
          for i in $(seq 1 120); do
            STATUS="$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query "Status" --output text 2>/dev/null || true)"
            echo "Invocation status: ${STATUS:-<none>} (attempt $i/120)"
            if [[ "$STATUS" == "Success" || "$STATUS" == "Failed" || "$STATUS" == "TimedOut" || "$STATUS" == "Cancelled" ]]; then
              break
            fi
            sleep 5
          done

          echo "---- SSM invocation status ----"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "{Status:Status,StatusDetails:StatusDetails,ResponseCode:ResponseCode}" \
            --output table || true

          echo "---- SSM STDOUT ----"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardOutputContent" \
            --output text || true

          echo "---- SSM STDERR ----"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardErrorContent" \
            --output text || true

          # Fail job if SSM didn't succeed
          FINAL_STATUS="$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --query "Status" --output text 2>/dev/null || true)"
          if [ "$FINAL_STATUS" != "Success" ]; then
            echo "SSM command did not succeed: $FINAL_STATUS"
            exit 1
          fi